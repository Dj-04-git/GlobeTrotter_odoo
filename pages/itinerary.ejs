<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trip Itinerary - Globe Trotter</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    gold: {
                        400: '#d4a574',
                        500: '#c4945a',
                        600: '#b08450',
                    }
                }
            }
        }
    }
  </script>
</head>
<body class="min-h-screen bg-base-200 font-sans text-base-content">
  <div class="flex">
    <!-- Sidebar -->
    <%- include('partials/sidebar', { currentPage: 'itinerary' }) %>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-64 p-4 md:p-8">
      <div class="max-w-4xl mx-auto">
    
    <!-- Header -->
    <div class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h1 id="tripTitle" class="text-3xl font-bold text-gray-800">Loading...</h1>
            <div class="text-sm text-gray-500 mt-2">
              Trip from <span id="tripStartDate" class="font-semibold text-primary"></span> to <span id="tripEndDate" class="font-semibold text-primary"></span>
            </div>
          </div>
          <button class="btn btn-outline btn-primary" onclick="goBack()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            Back to Trips
          </button>
        </div>
      </div>
    </div>

    <!-- Warning Alert -->
    <div id="dateWarning" role="alert" class="alert alert-warning mb-6 hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
      <span><strong>Date Warning:</strong> One or more sections exceed the trip dates. Please adjust the dates.</span>
    </div>

    <!-- Error Alert -->
    <div id="errorMessage" role="alert" class="alert alert-error mb-6 hidden">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      <span id="errorText"></span>
    </div>

    <!-- Sections Container -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div id="sectionsContainer"></div>

        <button class="btn btn-success w-full text-white mb-6" onclick="addSection()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
            Add Another Section
        </button>

        <div class="flex gap-4 mt-4">
          <button class="btn btn-primary flex-1" onclick="saveItinerary()">Save Itinerary</button>
          <button class="btn btn-neutral flex-1" onclick="goBack()">Cancel</button>
        </div>
      </div>
    </div>
      </div>
    </main>
  </div>

  <script>
    let tripId = null;
    let tripStartDate = null;
    let tripEndDate = null;
    let sections = [];
    let sectionCounter = 0;

    // Get tripId from URL
    function getTripIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('tripId');
    }

    // Load trip data and existing itinerary
    async function loadTrip() {
      try {
        tripId = getTripIdFromUrl();
        if (!tripId) {
          showError('Trip ID not found');
          return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
          showError('Authentication token not found. Please login again.');
          return;
        }

        const response = await fetch(`/api/trips/${tripId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('API Error:', errorData);
          showError(`Failed to load trip: ${errorData.error || response.statusText}`);
          return;
        }

        const trip = await response.json();
        console.log('Trip data loaded:', trip);
        
        tripStartDate = new Date(trip.start_date);
        tripEndDate = new Date(trip.end_date);

        document.getElementById('tripTitle').textContent = trip.title;
        document.getElementById('tripStartDate').textContent = formatDate(tripStartDate);
        document.getElementById('tripEndDate').textContent = formatDate(tripEndDate);

        // Load existing sections
        await loadSections(trip.stops || []);

        // If no existing sections, add an empty one
        if (sections.length === 0) {
          addSection();
        }

        renderSections();
      } catch (error) {
        console.error('Error loading trip:', error);
        showError('Error loading trip data: ' + error.message);
      }
    }

    // Load existing sections from the trip
    async function loadSections(stops) {
      sections = stops.map(stop => ({
        id: stop.id || null,
        startDate: stop.start_date,
        endDate: stop.end_date,
        description: stop.description || '',
        budget: stop.budget || 0,
        position: stop.position || sections.length
      }));

      sectionCounter = sections.length;
    }

    // Format date for display
    function formatDate(date) {
      if (typeof date === 'string') {
        date = new Date(date);
      }
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Add a new section
    function addSection() {
      sections.push({
        id: null,
        startDate: formatDateForInput(tripStartDate),
        endDate: formatDateForInput(tripEndDate),
        description: '',
        budget: 0,
        position: sections.length
      });
      sectionCounter++;
      renderSections();
    }

    // Format date for input field
    function formatDateForInput(date) {
      if (typeof date === 'string') {
        date = new Date(date);
      }
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Remove a section
    function removeSection(index) {
      sections.splice(index, 1);
      renderSections();
    }

    // Validate dates
    function validateDates() {
      let hasError = false;

      sections.forEach((section, index) => {
        const sectionStart = new Date(section.startDate);
        const sectionEnd = new Date(section.endDate);

        const errorEl = document.getElementById(`error-${index}`);
        if (errorEl) {
          errorEl.classList.add('hidden');
        }

        // Check if dates are within trip range
        if (sectionStart < tripStartDate || sectionEnd > tripEndDate || sectionStart > sectionEnd) {
          hasError = true;
          if (errorEl) {
            if (sectionStart > sectionEnd) {
              errorEl.textContent = 'End date must be after start date';
            } else {
              errorEl.textContent = `Dates must be between ${formatDate(tripStartDate)} and ${formatDate(tripEndDate)}`;
            }
            errorEl.classList.remove('hidden');
          }
        }
      });

      const warningEl = document.getElementById('dateWarning');
      if (hasError) {
        warningEl.classList.remove('hidden');
      } else {
        warningEl.classList.add('hidden');
      }

      return !hasError;
    }

    // Render sections
    function renderSections() {
      const container = document.getElementById('sectionsContainer');
      container.innerHTML = '';

      sections.forEach((section, index) => {
        const sectionHtml = `
          <div class="card bg-base-200 border border-base-300 p-6 mb-6" id="section-${index}">
            <div class="flex justify-between items-center mb-4">
              <div class="text-lg font-bold text-gray-700">Section ${index + 1}</div>
              ${sections.length > 1 ? `<button class="btn btn-error btn-sm text-white" onclick="removeSection(${index})">Remove</button>` : ''}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
              <div class="form-control w-full">
                <label class="label" for="startDate-${index}">
                    <span class="label-text font-semibold">Start Date</span>
                </label>
                <input 
                  type="date" 
                  class="input input-bordered w-full"
                  id="startDate-${index}" 
                  value="${section.startDate}"
                  min="${formatDateForInput(tripStartDate)}"
                  max="${formatDateForInput(tripEndDate)}"
                  onchange="updateSection(${index}, 'startDate', this.value)"
                >
                <div class="text-error text-xs mt-1 hidden" id="error-${index}"></div>
              </div>

              <div class="form-control w-full">
                <label class="label" for="endDate-${index}">
                    <span class="label-text font-semibold">End Date</span>
                </label>
                <input 
                  type="date" 
                  class="input input-bordered w-full"
                  id="endDate-${index}" 
                  value="${section.endDate}"
                  min="${formatDateForInput(tripStartDate)}"
                  max="${formatDateForInput(tripEndDate)}"
                  onchange="updateSection(${index}, 'endDate', this.value)"
                >
              </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-4">
              <div class="form-control w-full">
                <label class="label" for="budget-${index}">
                    <span class="label-text font-semibold">Budget for this Section (â‚¹)</span>
                </label>
                <input 
                  type="number" 
                  class="input input-bordered w-full"
                  id="budget-${index}" 
                  value="${section.budget}"
                  min="0"
                  placeholder="Enter budget"
                  onchange="updateSection(${index}, 'budget', this.value)"
                >
              </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
              <div class="form-control w-full">
                <label class="label" for="description-${index}">
                    <span class="label-text font-semibold">What will you do in this section?</span>
                </label>
                <textarea 
                  class="textarea textarea-bordered w-full h-24"
                  id="description-${index}" 
                  placeholder="Describe your activities, travel plans, accommodations, or anything else for this section..."
                  onchange="updateSection(${index}, 'description', this.value)"
                >${section.description}</textarea>
              </div>
            </div>
          </div>
        `;

        container.innerHTML += sectionHtml;
      });

      // Re-validate after rendering
      validateDates();
    }

    // Update section data
    function updateSection(index, field, value) {
      if (sections[index]) {
        sections[index][field] = value;
        validateDates();
      }
    }

    // Save itinerary
    async function saveItinerary() {
      if (!validateDates()) {
        showError('Please fix date validation errors before saving');
        return;
      }

      try {
        const token = localStorage.getItem('token');

        // Save each section as a stop
        for (let i = 0; i < sections.length; i++) {
          const section = sections[i];

          const stopData = {
            trip_id: parseInt(tripId),
            start_date: section.startDate,
            end_date: section.endDate,
            description: section.description,
            budget: parseInt(section.budget) || 0,
            position: i
          };

          const url = section.id ? `/api/stops/${section.id}` : '/api/stops';
          const method = section.id ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(stopData)
          });

          if (!response.ok) {
            const errorData = await response.json();
            showError(`Error saving section ${i + 1}: ${errorData.message || 'Unknown error'}`);
            return;
          }

          const result = await response.json();
          sections[i].id = result.id;
        }

        // Redirect back to trips
        window.location.href = '/trips';
      } catch (error) {
        console.error('Error saving itinerary:', error);
        showError('Error saving itinerary');
      }
    }

    // Show error message
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      const errorText = document.getElementById('errorText');
      errorText.textContent = message;
      errorEl.classList.remove('hidden');
      setTimeout(() => {
        errorEl.classList.add('hidden');
      }, 5000);
    }

    // Go back to trips
    function goBack() {
      window.location.href = '/trips';
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', loadTrip);
  </script>
</body>
</html>