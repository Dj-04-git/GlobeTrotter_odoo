<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register User - GlobalTrotter</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js and Alpine Ajax -->
    <script defer src="https://cdn.jsdelivr.net/npm/@imacrayon/alpine-ajax@0.12.6/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            400: '#d4a574',
                            500: '#c4945a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-br from-[#f5f0e8] to-[#f0ebe0] font-sans">
    
    <!-- Navbar -->
    <div class="navbar bg-base-100/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost text-xl font-bold text-gray-800">Global<span class="text-gold-500">Trotter</span></a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1 text-sm font-medium text-gray-600">
                <li><a href="/login" class="hover:text-gold-500">Login</a></li>
                <li><a href="/register" class="text-gold-500 active:bg-transparent hover:text-gold-600">Register</a></li>
            </ul>
        </div>
    </div>

    <main class="flex-grow flex items-center justify-center p-5">
        <!-- Increased max-width to accommodate 2-column layout -->
        <div class="card w-full max-w-2xl bg-base-100 shadow-2xl" x-data="registerForm()">
            <div class="card-body p-8">
                <div class="text-center mb-6">
                    <!-- Photo Placeholder with Emoji -->
                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-gold-400 to-gold-500 border-4 border-white flex flex-col items-center justify-center mx-auto mb-4 text-gray-400 shadow-md">
                        <span class="text-3xl mb-1">☺️</span>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">Register User</h1>
                </div>

                <div class="alert alert-success text-sm py-2" x-show="successMessage" x-transition x-cloak>
                    <span x-text="successMessage"></span>
                </div>

                <form @submit.prevent="submitForm" class="space-y-4">
                    
                    <!-- Row 1: First Name & Last Name -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">First Name</span>
                            </label>
                            <input type="text" x-model="formData.firstName" placeholder="First Name" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" :class="{'input-error': errors.firstName}" required />
                        </div>
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">Last Name</span>
                            </label>
                            <input type="text" x-model="formData.lastName" placeholder="Last Name" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" :class="{'input-error': errors.lastName}" required />
                        </div>
                    </div>

                    <!-- Row 2: Email & Phone -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">Email Address</span>
                            </label>
                            <input type="email" x-model="formData.email" placeholder="Email Address" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" :class="{'input-error': errors.email}" required />
                            <label class="label py-0" x-show="errors.email" x-cloak>
                                <span class="label-text-alt text-error" x-text="errors.email"></span>
                            </label>
                        </div>
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">Phone Number</span>
                            </label>
                            <input type="tel" x-model="formData.phone" placeholder="Phone Number" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" />
                        </div>
                    </div>

                    <!-- Row 3: City & Country -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">City</span>
                            </label>
                            <input type="text" x-model="formData.city" placeholder="City" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" />
                        </div>
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">Country</span>
                            </label>
                            <input type="text" x-model="formData.country" placeholder="Country" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" />
                        </div>
                    </div>

                    <!-- Row 4: Additional Information -->
                    <div class="form-control w-full">
                        <label class="label py-1">
                            <span class="label-text text-xs font-medium text-gray-600">Additional Information</span>
                        </label>
                        <textarea x-model="formData.additionalInfo" class="textarea textarea-bordered h-24 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" placeholder="Any other details..."></textarea>
                    </div>

                    <!-- Password Fields -->
                    <div class="divider text-xs text-gray-400">Security</div>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">Password</span>
                            </label>
                            <input type="password" x-model="formData.password" placeholder="Password" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" :class="{'input-error': errors.password}" required />
                            <label class="label py-0" x-show="errors.password" x-cloak>
                                <span class="label-text-alt text-error" x-text="errors.password"></span>
                            </label>
                        </div>

                        <div class="form-control w-full">
                            <label class="label py-1">
                                <span class="label-text text-xs font-medium text-gray-600">Confirm Password</span>
                            </label>
                            <input type="password" x-model="formData.confirmPassword" placeholder="Confirm Password" class="input input-bordered w-full h-10 text-sm focus:border-gold-400 focus:outline-none bg-gray-50 focus:bg-white transition-colors" :class="{'input-error': errors.confirmPassword}" required />
                            <label class="label py-0" x-show="errors.confirmPassword" x-cloak>
                                <span class="label-text-alt text-error" x-text="errors.confirmPassword"></span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="btn w-full bg-gradient-to-br from-gold-400 to-gold-500 border-none text-white hover:shadow-lg hover:-translate-y-0.5 transition-all" :disabled="isLoading">
                            <span x-show="isLoading" class="loading loading-spinner loading-sm"></span>
                            <span x-show="!isLoading">Register User</span>
                        </button>
                    </div>
                </form>

                <div class="text-center mt-6 text-xs text-gray-500">
                    Already have an account? <a href="/login" class="text-gold-400 font-semibold hover:text-gold-500 transition-colors">Sign in</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        function registerForm() {
            return {
                formData: {
                    firstName: '',
                    lastName: '',
                    email: '',
                    phone: '',
                    city: '',
                    country: '',
                    additionalInfo: '',
                    password: '',
                    confirmPassword: ''
                },
                errors: {},
                isLoading: false,
                successMessage: '',

                async submitForm() {
                    this.errors = {};
                    this.successMessage = '';
                    
                    // Client-side validation
                    if (this.formData.password !== this.formData.confirmPassword) {
                        this.errors.confirmPassword = 'Passwords do not match';
                        return;
                    }
                    if (this.formData.password.length < 6) {
                        this.errors.password = 'Password must be at least 6 characters';
                        return;
                    }

                    this.isLoading = true;

                    // Construct payload - Map form fields to expected backend fields
                    const payload = {
                        name: `${this.formData.firstName} ${this.formData.lastName}`,
                        email: this.formData.email,
                        password: this.formData.password,
                        phone: this.formData.phone || null,
                        location: (this.formData.city || '') + (this.formData.country ? `, ${this.formData.country}` : ''),
                        about: this.formData.additionalInfo || null
                    };

                    console.log('Sending payload:', payload);

                    try {
                        const response = await fetch('/api/auth/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.successMessage = 'Registration successful! Redirecting to OTP verification...';
                            sessionStorage.setItem('registerEmail', this.formData.email);
                            setTimeout(() => {
                                window.location.href = '/verify-otp';
                            }, 1500);
                        } else {
                            const errorMsg = data.error || data.message || 'Registration failed';
                            if (errorMsg.toLowerCase().includes('email')) {
                                this.errors.email = errorMsg;
                            } else if (errorMsg.toLowerCase().includes('password')) {
                                this.errors.password = errorMsg;
                            } else {
                                this.errors.email = errorMsg; // Default to email field for general errors
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.errors.email = 'An error occurred. Please try again.';
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
