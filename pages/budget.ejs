<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Budget - GlobalTrotter</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js and Alpine Ajax -->
    <script defer src="https://cdn.jsdelivr.net/npm/@imacrayon/alpine-ajax@0.12.6/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script> 
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: {
                            400: '#d4a574',
                            500: '#c4945a',
                            600: '#b08450',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="min-h-screen bg-base-200 font-sans text-base-content">
    <div class="flex" x-data="budgetApp()">
        <!-- Sidebar -->
        <%- include('partials/sidebar', { currentPage: 'budgets' }) %>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 p-8 transition-all duration-300">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Trip Budget</h2>
                    <p class="text-gray-500 mt-1">Track expenses for your itinerary</p>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Trip Selector -->
                    <select class="select select-bordered w-full max-w-xs focus:border-gold-400 focus:outline-none" x-model="selectedTripId" @change="loadTripData">
                        <option value="" disabled>Select a trip</option>
                        <template x-for="trip in trips" :key="trip.id">
                            <option :value="trip.id" x-text="trip.title"></option>
                        </template>
                    </select>

                    <!-- User Profile -->
                    <div class="avatar placeholder cursor-pointer" @click="window.location.href='/profile'">
                        <div class="bg-gold-400 text-white rounded-full w-10">
                            <span class="text-lg">U</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="isLoading" class="flex justify-center py-12" x-cloak>
                <span class="loading loading-spinner loading-lg text-gold-400"></span>
            </div>

            <!-- Empty State -->
            <div x-show="!isLoading && !selectedTripId" class="text-center py-12" x-cloak>
                <div class="text-6xl mb-4">ðŸ’°</div>
                <h3 class="text-xl font-bold text-gray-600">Select a trip to view budget</h3>
            </div>

            <!-- Content -->
            <div x-show="!isLoading && selectedTripId" x-transition x-cloak>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card bg-base-100 shadow-md border-l-4 border-gold-400">
                        <div class="card-body p-6">
                            <h3 class="text-gray-500 text-sm font-medium uppercase">Total Estimated Cost</h3>
                            <p class="text-3xl font-bold text-gray-800" x-text="formatCurrency(totalCost)"></p>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-md border-l-4 border-blue-400">
                        <div class="card-body p-6">
                            <h3 class="text-gray-500 text-sm font-medium uppercase">Total Stops</h3>
                            <p class="text-3xl font-bold text-gray-800" x-text="totalItems"></p>
                        </div>
                    </div>
                    <div class="card bg-base-100 shadow-md border-l-4 border-green-400">
                        <div class="card-body p-6">
                            <h3 class="text-gray-500 text-sm font-medium uppercase">Avg. Cost per Stop</h3>
                            <p class="text-3xl font-bold text-gray-800" x-text="formatCurrency(avgCostPerStop)"></p>
                        </div>
                    </div>
                </div>

                <!-- Itinerary Table -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body p-0">
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <!-- Head -->
                                <thead class="bg-base-200 text-gray-600">
                                    <tr>
                                        <th class="w-2/3 pl-8">Stop / Activity</th>
                                        <th class="w-1/3 text-right pr-8">Budget</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(dayGroup, index) in groupedItinerary" :key="index">
                                        <tr class="bg-gray-50">
                                            <td colspan="2" class="font-bold text-gray-700 pl-6 py-3">
                                                <div class="badge badge-neutral mr-2" x-text="'Day ' + (index + 1)"></div>
                                                <span x-text="formatDate(dayGroup.date)"></span>
                                            </td>
                                        </tr>
                                        <template x-for="item in dayGroup.items" :key="item.id">
                                            <tr class="hover:bg-base-50 border-b border-base-100">
                                                <td class="pl-8">
                                                    <div class="font-medium" x-text="item.stop_name || item.name || 'Unnamed Stop'"></div>
                                                    <div class="text-xs text-gray-500" x-text="item.notes || ''"></div>
                                                </td>
                                                <td class="text-right pr-8 font-mono text-gray-700">
                                                    <span x-text="formatCurrency(item.budget || 0)"></span>
                                                </td>
                                            </tr>
                                        </template>
                                        <!-- Day Subtotal -->
                                        <tr class="bg-base-100">
                                            <td class="text-right font-medium text-sm text-gray-500 pr-4">Day Total:</td>
                                            <td class="text-right pr-8 font-bold text-gray-800" x-text="formatCurrency(dayGroup.total)"></td>
                                        </tr>
                                    </template>
                                    
                                    <template x-if="groupedItinerary.length === 0">
                                        <tr>
                                            <td colspan="2" class="text-center py-8 text-gray-500">
                                                No stops found for this trip. 
                                                <a :href="'/itinerary?tripId=' + selectedTripId" class="text-gold-500 hover:underline">Add stops to itinerary</a>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        function budgetApp() {
            return {
                trips: [],
                selectedTripId: '',
                itineraryItems: [],
                isLoading: false,
                
                init() {
                    this.fetchTrips();
                },

                async fetchTrips() {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/login';
                        return;
                    }

                    try {
                        const response = await fetch('/api/trips', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.trips = data.trips || [];
                            
                            // Check URL params for tripId
                            const urlParams = new URLSearchParams(window.location.search);
                            const tripIdParam = urlParams.get('tripId');
                            
                            if (tripIdParam) {
                                this.selectedTripId = tripIdParam;
                                this.loadTripData();
                            } else if (this.trips.length > 0) {
                                this.selectedTripId = this.trips[0].id;
                                this.loadTripData();
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching trips:', error);
                    }
                },

                async loadTripData() {
                    if (!this.selectedTripId) return;
                    
                    this.isLoading = true;
                    const token = localStorage.getItem('token');

                    try {
                        // Fetching from the itinerary route which returns stops
                        const response = await fetch(`/api/trips/${this.selectedTripId}/itinerary`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            // The controller returns { sections: [...] } where sections are rows from the stops table
                            this.itineraryItems = data.sections || [];
                        } else {
                            this.itineraryItems = [];
                        }
                    } catch (error) {
                        console.error('Error fetching itinerary:', error);
                        this.itineraryItems = [];
                    } finally {
                        this.isLoading = false;
                    }
                },

                get groupedItinerary() {
                    if (!this.itineraryItems.length) return [];

                    // Sort items by date
                    const sortedItems = [...this.itineraryItems].sort((a, b) => {
                        return new Date(a.date) - new Date(b.date);
                    });

                    // Group by date
                    const groups = {};
                    sortedItems.forEach(item => {
                        const dateStr = item.date ? item.date.split('T')[0] : 'Unscheduled';
                        
                        if (!groups[dateStr]) {
                            groups[dateStr] = {
                                date: dateStr,
                                items: [],
                                total: 0
                            };
                        }
                        
                        // Ensure budget is a number. The field in DB is likely 'budget'
                        const cost = parseFloat(item.budget || 0);
                        item.budget = cost; // Normalize for display
                        
                        groups[dateStr].items.push(item);
                        groups[dateStr].total += cost;
                    });

                    return Object.values(groups).sort((a, b) => a.date.localeCompare(b.date));
                },

                get totalCost() {
                    return this.itineraryItems.reduce((sum, item) => sum + parseFloat(item.budget || 0), 0);
                },

                get totalItems() {
                    return this.itineraryItems.length;
                },

                get avgCostPerStop() {
                    const count = this.totalItems;
                    return count > 0 ? this.totalCost / count : 0;
                },

                formatCurrency(value) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(value);
                },

                formatDate(dateStr) {
                    if (dateStr === 'Unscheduled') return dateStr;
                    // Adjust for timezone issues by creating date from parts
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const date = new Date(parts[0], parts[1] - 1, parts[2]);
                        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    }
                    return dateStr;
                }
            }
        }
    </script>
</body>
</html>